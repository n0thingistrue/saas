# =============================================================================
# CI - Infrastructure Validation
# =============================================================================
# Valide les fichiers Kubernetes et Terraform a chaque push.
# Jobs : validate-k8s, validate-terraform
# =============================================================================
name: Infrastructure CI

on:
  push:
    branches: [main, develop]
    paths:
      - "kubernetes/**"
      - "terraform/**"
      - ".github/workflows/ci-infrastructure.yaml"
  pull_request:
    branches: [main]
    paths:
      - "kubernetes/**"
      - "terraform/**"

jobs:
  # =========================================================================
  # Job 1 : Validate Kubernetes Manifests
  # =========================================================================
  validate-k8s:
    name: Validate K8s Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Validate YAML syntax
        run: |
          echo "=== Validating YAML syntax ==="
          find kubernetes/ -name "*.yaml" -o -name "*.yml" | while read f; do
            if ! python3 -c "import yaml; yaml.safe_load(open('$f'))" 2>/dev/null; then
              echo "INVALID: $f"
              exit 1
            fi
          done
          echo "All YAML files are valid"

      - name: Kustomize build (dry-run)
        run: |
          echo "=== Building kustomize overlays ==="
          for dir in kubernetes/base kubernetes/databases kubernetes/apps kubernetes/monitoring kubernetes/ingress; do
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Building: $dir"
              kubectl kustomize "$dir" > /dev/null
              echo "OK: $dir"
            fi
          done

      - name: Run Checkov (IaC security scan)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: kubernetes/
          framework: kubernetes
          quiet: true
          soft_fail: true
          output_format: cli
          skip_check: CKV_K8S_40,CKV_K8S_43

  # =========================================================================
  # Job 2 : Validate Terraform
  # =========================================================================
  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7"

      - name: Terraform fmt check
        run: terraform fmt -check -recursive -diff

      - name: Terraform init
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

      - name: Run Checkov (Terraform security)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform
          quiet: true
          soft_fail: true
          output_format: cli

  # =========================================================================
  # Job 3 : Notify
  # =========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [validate-k8s, validate-terraform]
    if: always() && failure()
    steps:
      - name: Slack notification on failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,message,commit,author,workflow
          text: "Infrastructure validation failed!"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
