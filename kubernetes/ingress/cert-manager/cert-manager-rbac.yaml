# =============================================================================
# RBAC - cert-manager
# =============================================================================
# ServiceAccounts et permissions pour les 3 composants cert-manager :
#   - cert-manager : controller principal
#   - cert-manager-webhook : validation admission
#   - cert-manager-cainjector : injection CA bundles
#
# Installation recommandee : utiliser le Helm chart officiel.
# Ce fichier fournit le RBAC minimal si deploiement sans Helm.
# =============================================================================
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-manager
  namespace: cert-manager
  labels:
    app: cert-manager
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: controller
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-manager-webhook
  namespace: cert-manager
  labels:
    app: cert-manager
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: webhook
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-manager-cainjector
  namespace: cert-manager
  labels:
    app: cert-manager
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: cainjector
---
# ClusterRole pour le controller cert-manager
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-manager-controller
  labels:
    app: cert-manager
rules:
  # Gestion des certificats
  - apiGroups: ["cert-manager.io"]
    resources:
      - certificates
      - certificates/status
      - certificaterequests
      - certificaterequests/status
      - issuers
      - issuers/status
      - clusterissuers
      - clusterissuers/status
      - orders
      - orders/status
      - challenges
      - challenges/status
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Gestion des secrets TLS
  - apiGroups: [""]
    resources:
      - secrets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Events
  - apiGroups: [""]
    resources:
      - events
    verbs: ["create", "patch"]
  # Ingress pour HTTP-01 challenge
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
      - ingresses/finalizers
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Pods et services pour HTTP-01 solver
  - apiGroups: [""]
    resources:
      - pods
      - services
    verbs: ["get", "list", "watch", "create", "delete"]
  # Gateway API (optionnel)
  - apiGroups: ["gateway.networking.k8s.io"]
    resources:
      - gateways
      - httproutes
    verbs: ["get", "list", "watch", "update"]
  # Leader election
  - apiGroups: ["coordination.k8s.io"]
    resources:
      - leases
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-manager-controller
  labels:
    app: cert-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-manager-controller
subjects:
  - kind: ServiceAccount
    name: cert-manager
    namespace: cert-manager
---
# ClusterRole pour le webhook
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-manager-webhook
  labels:
    app: cert-manager
rules:
  - apiGroups: ["admissionregistration.k8s.io"]
    resources:
      - validatingwebhookconfigurations
      - mutatingwebhookconfigurations
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: [""]
    resources:
      - secrets
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apiregistration.k8s.io"]
    resources:
      - apiservices
    verbs: ["get", "list", "watch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-manager-webhook
  labels:
    app: cert-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-manager-webhook
subjects:
  - kind: ServiceAccount
    name: cert-manager-webhook
    namespace: cert-manager
---
# ClusterRole pour le cainjector
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cert-manager-cainjector
  labels:
    app: cert-manager
rules:
  - apiGroups: ["cert-manager.io"]
    resources:
      - certificates
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources:
      - secrets
    verbs: ["get", "list", "watch"]
  - apiGroups: ["admissionregistration.k8s.io"]
    resources:
      - validatingwebhookconfigurations
      - mutatingwebhookconfigurations
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["apiregistration.k8s.io"]
    resources:
      - apiservices
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["apiextensions.k8s.io"]
    resources:
      - customresourcedefinitions
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["coordination.k8s.io"]
    resources:
      - leases
    verbs: ["get", "list", "watch", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cert-manager-cainjector
  labels:
    app: cert-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cert-manager-cainjector
subjects:
  - kind: ServiceAccount
    name: cert-manager-cainjector
    namespace: cert-manager
