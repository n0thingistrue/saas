# =============================================================================
# ConfigMap - Traefik Static Configuration
# =============================================================================
# Configuration statique Traefik v3.0.
# Chargee au demarrage via --configFile=/config/traefik.yaml.
#
# EntryPoints :
#   - web (80) : HTTP, redirect automatique vers HTTPS
#   - websecure (443) : HTTPS, TLS 1.3 minimum
#   - metrics (9100) : Prometheus metrics
#   - traefik (8080) : Dashboard + API + /ping
#
# Providers :
#   - kubernetesCRD : IngressRoute, Middleware, TLSOption
#   - kubernetesIngress : Ingress standard K8s
#
# TLS :
#   - Minimum version TLS 1.3
#   - Cipher suites modernes uniquement
#   - ACME via cert-manager (pas le resolver interne Traefik)
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-config
  namespace: ingress
  labels:
    app: traefik
    app.kubernetes.io/name: traefik
    app.kubernetes.io/component: config
data:
  traefik.yaml: |
    # =========================================================================
    # Global
    # =========================================================================
    global:
      checkNewVersion: false
      sendAnonymousUsage: false

    # =========================================================================
    # EntryPoints
    # =========================================================================
    entryPoints:
      # HTTP - Redirection automatique vers HTTPS
      web:
        address: ":80"
        http:
          redirections:
            entryPoint:
              to: websecure
              scheme: https
              permanent: true
        # Protection contre les requetes trop volumineuses
        transport:
          respondingTimeouts:
            readTimeout: 60s
            writeTimeout: 60s
            idleTimeout: 180s

      # HTTPS - Point d'entree principal
      websecure:
        address: ":443"
        http:
          tls: {}
          middlewares:
            # Middlewares appliques globalement sur HTTPS
            - security-headers@kubernetescrd
        transport:
          respondingTimeouts:
            readTimeout: 60s
            writeTimeout: 60s
            idleTimeout: 180s
        # Proxy Protocol v2 (Hetzner Load Balancer)
        proxyProtocol:
          trustedIPs:
            - "127.0.0.1/32"
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"
        forwardedHeaders:
          trustedIPs:
            - "127.0.0.1/32"
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"

      # Metrics Prometheus
      metrics:
        address: ":9100"

      # Dashboard + API interne
      traefik:
        address: ":8080"

    # =========================================================================
    # API / Dashboard
    # =========================================================================
    api:
      dashboard: true
      # Securise par IngressRoute + BasicAuth
      insecure: false

    # =========================================================================
    # Ping (Health Check)
    # =========================================================================
    ping:
      entryPoint: traefik

    # =========================================================================
    # Providers
    # =========================================================================
    providers:
      # CRDs Traefik (IngressRoute, Middleware, TLSOption...)
      kubernetesCRD:
        allowCrossNamespace: true
        allowExternalNameServices: false
      # Ingress standard Kubernetes
      kubernetesIngress:
        allowExternalNameServices: false
        publishedService:
          enabled: true

    # =========================================================================
    # Logging
    # =========================================================================
    log:
      level: INFO
      format: json

    # Access Log (toutes les requetes HTTP)
    accessLog:
      format: json
      filePath: "/var/log/traefik/access.log"
      bufferingSize: 100
      filters:
        statusCodes:
          - "200-299"
          - "300-399"
          - "400-499"
          - "500-599"
        retryAttempts: true
        minDuration: "10ms"
      fields:
        defaultMode: keep
        names:
          ClientUsername: drop
        headers:
          defaultMode: drop
          names:
            User-Agent: keep
            Content-Type: keep
            X-Forwarded-For: keep
            X-Real-Ip: keep

    # =========================================================================
    # Metrics Prometheus
    # =========================================================================
    metrics:
      prometheus:
        entryPoint: metrics
        addEntryPointsLabels: true
        addRoutersLabels: true
        addServicesLabels: true
        buckets:
          - 0.01
          - 0.05
          - 0.1
          - 0.25
          - 0.5
          - 1.0
          - 2.5
          - 5.0
          - 10.0

    # =========================================================================
    # TLS Options (globales)
    # =========================================================================
    # Les options TLS detaillees sont dans le CRD TLSOption
    # Ici on definit le minimum global
    tls:
      options:
        default:
          minVersion: VersionTLS13
          sniStrict: true
