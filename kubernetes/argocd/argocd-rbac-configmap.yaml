# =============================================================================
# ConfigMap - ArgoCD RBAC
# =============================================================================
# Politique RBAC pour ArgoCD.
# Roles :
#   - admin : acces complet (sync, delete, create apps)
#   - developer : deployer des applications (sync, get, override)
#   - readonly : consultation uniquement (default)
#
# Integration LDAP :
#   - Groupe "admins" → role admin
#   - Groupe "developers" → role developer
#   - Autres → readonly
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  # Role par defaut pour les utilisateurs non mappes
  policy.default: role:readonly

  # Scopes OIDC/LDAP (groups viennent des groupes LDAP)
  scopes: "[groups]"

  # Politiques RBAC
  policy.csv: |
    # =============================================
    # Role : admin (acces complet)
    # =============================================
    p, role:admin, applications, *, */*, allow
    p, role:admin, clusters, *, *, allow
    p, role:admin, repositories, *, *, allow
    p, role:admin, certificates, *, *, allow
    p, role:admin, accounts, *, *, allow
    p, role:admin, gpgkeys, *, *, allow
    p, role:admin, logs, *, *, allow
    p, role:admin, exec, *, *, allow

    # =============================================
    # Role : developer (deploy apps seulement)
    # =============================================
    p, role:developer, applications, get, */*, allow
    p, role:developer, applications, sync, */*, allow
    p, role:developer, applications, override, */*, allow
    p, role:developer, applications, action/*, */*, allow
    p, role:developer, logs, get, */*, allow
    p, role:developer, repositories, get, *, allow
    p, role:developer, clusters, get, *, allow

    # =============================================
    # Mapping groupes LDAP → roles ArgoCD
    # =============================================
    # Groupe LDAP "admins" → role admin
    g, admins, role:admin
    # Groupe LDAP "developers" → role developer
    g, developers, role:developer
    # Groupe LDAP "sysadmins" → role admin
    g, sysadmins, role:admin
