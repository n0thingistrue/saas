# =============================================================================
# Services PostgreSQL
# =============================================================================
# 3 services pour differents patterns d'acces :
#
# 1. postgresql-headless : Service headless pour le StatefulSet
#    (DNS : postgresql-0.postgresql-headless.production.svc.cluster.local)
#
# 2. postgresql-primary : Pointe vers le PRIMARY Patroni
#    (Utilise par le backend pour les ecritures)
#    Selection via le label "role: master" mis a jour par Patroni
#
# 3. postgresql-replica : Pointe vers les STANDBY
#    (Utilise par les lectures non-critiques / rapports)
#    Selection via le label "role: replica"
# =============================================================================
---
# -----------------------------------------------------------------------------
# Service headless (requis par le StatefulSet)
# Permet la resolution DNS directe de chaque pod :
#   postgresql-0.postgresql-headless.production.svc.cluster.local
#   postgresql-1.postgresql-headless.production.svc.cluster.local
# Utilise par Patroni pour la communication inter-pods
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: postgresql-headless
  namespace: production
  labels:
    app: postgresql
    cluster-name: postgresql-ha
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: headless-service
    app.kubernetes.io/part-of: database
  annotations:
    description: "Service headless pour le StatefulSet PostgreSQL et la decouverte Patroni"
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      protocol: TCP
    - name: patroni
      port: 8008
      targetPort: 8008
      protocol: TCP
  selector:
    app: postgresql
    cluster-name: postgresql-ha
---
# -----------------------------------------------------------------------------
# Service Primary (Read-Write)
# Pointe vers le primary Patroni grace au endpoint mis a jour automatiquement.
#
# Patroni met a jour les endpoints Kubernetes pour pointer vers le leader.
# Le service utilise le nom de scope Patroni comme selecteur.
#
# URL de connexion pour le backend :
#   postgresql://saas_app:<password>@postgresql-primary.production.svc:5432/saas_production
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: postgresql-primary
  namespace: production
  labels:
    app: postgresql
    role: primary
    cluster-name: postgresql-ha
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: primary-service
    app.kubernetes.io/part-of: database
  annotations:
    description: "Service Read-Write - pointe vers le primary PostgreSQL Patroni"
spec:
  type: ClusterIP
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      protocol: TCP
    - name: patroni
      port: 8008
      targetPort: 8008
      protocol: TCP
    - name: metrics
      port: 9187
      targetPort: 9187
      protocol: TCP
  selector:
    app: postgresql
    cluster-name: postgresql-ha
    # Ce label est mis a jour dynamiquement par Patroni
    # Le pod primary porte le label role=master
    role: master
---
# -----------------------------------------------------------------------------
# Service Replica (Read-Only)
# Pointe vers les replicas pour les lectures non-critiques.
# Utile pour les rapports, exports, requetes analytiques.
#
# URL de connexion :
#   postgresql://saas_readonly:<password>@postgresql-replica.production.svc:5432/saas_production
# -----------------------------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: postgresql-replica
  namespace: production
  labels:
    app: postgresql
    role: replica
    cluster-name: postgresql-ha
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: replica-service
    app.kubernetes.io/part-of: database
  annotations:
    description: "Service Read-Only - pointe vers les replicas PostgreSQL"
spec:
  type: ClusterIP
  ports:
    - name: postgresql
      port: 5432
      targetPort: 5432
      protocol: TCP
    - name: patroni
      port: 8008
      targetPort: 8008
      protocol: TCP
    - name: metrics
      port: 9187
      targetPort: 9187
      protocol: TCP
  selector:
    app: postgresql
    cluster-name: postgresql-ha
    role: replica
